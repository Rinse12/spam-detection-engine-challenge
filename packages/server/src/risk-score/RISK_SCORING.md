# Risk Scoring System

This document explains how EasyCommunitySpamBlocker calculates risk scores for publications.

## Overview

The risk score is a value between 0.0 and 1.0 that indicates the likelihood a publication is spam or malicious:

- **0.0 - 0.3**: Low risk (likely legitimate)
- **0.3 - 0.7**: Moderate risk (may require verification)
- **0.7 - 1.0**: High risk (likely spam/malicious)

The score is calculated as a weighted combination of multiple factors, each analyzing different aspects of the publication and its author.

## Trust Model

**Important**: Not all author data can be trusted equally.

- `author.subplebbit.*` fields are **TRUSTED** - they are generated by the subplebbit and verified
- All other `author.*` fields are **UNTRUSTED** - they are provided by the user and can be faked

**Exception**: `author.wallets` and `author.avatar` contain signatures that are verified by plebbit-js, proving actual wallet ownership. While these fields are user-provided, the verified wallet addresses can be used as reliable identifiers for tracking coordinated activity.

The risk scoring system primarily relies on trusted `author.subplebbit` data for reputation signals.

## Risk Factors

### 1. Account Age (Weight: 17% without IP, 12% with IP)

Evaluates how long the author has been active, using the **older** of:

1. `author.subplebbit.firstCommentTimestamp` (TRUSTED - from subplebbit)
2. First seen timestamp from the spam detection database

This dual-source approach ensures we capture the earliest known activity even when the subplebbit data is incomplete or when the spam detection system has older records.

| Account Age | Risk Score | Description                            |
| ----------- | ---------- | -------------------------------------- |
| > 365 days  | 0.10       | Very established, highly trusted       |
| > 90 days   | 0.20       | Established account                    |
| > 30 days   | 0.35       | Moderately established                 |
| > 7 days    | 0.50       | Some history                           |
| > 1 day     | 0.70       | New account                            |
| < 1 day     | 0.85       | Very new account                       |
| No history  | 0.90       | First interaction with this subplebbit |

**Rationale**: Older accounts have demonstrated sustained, non-malicious behavior over time.

### 2. Karma Score (Weight: 13% without IP, 8% with IP)

Evaluates the author's accumulated karma (`postScore + replyScore`) from `author.subplebbit`.

| Total Karma | Risk Score | Description                       |
| ----------- | ---------- | --------------------------------- |
| >= 100      | 0.10       | Highly trusted contributor        |
| >= 50       | 0.20       | Established contributor           |
| >= 10       | 0.35       | Positive contributor              |
| >= 0        | 0.50       | Neutral                           |
| >= -10      | 0.70       | Negative karma                    |
| < -10       | 0.90       | Very negative karma (problematic) |

**Rationale**: Karma reflects community trust. High karma indicates valued contributions; negative karma indicates problematic behavior.

### 3. Author Reputation (Weight: 25% without IP, 20% with IP)

Evaluates whether the author has verified publication history in this subplebbit.

| Signal               | Score Impact | Description                                |
| -------------------- | ------------ | ------------------------------------------ |
| Has `lastCommentCid` | -0.20        | Verified history exists in this subplebbit |
| No verified history  | +0.10        | No record of previous activity             |

**Note**: We intentionally do NOT use `author.previousCommentCid` as a trust signal because it's user-provided and can be faked.

**Rationale**: Authors with verified publication history have demonstrated willingness to participate legitimately.

### 4. Content Risk (Weight: 18% without IP, 12% with IP)

Analyzes the publication content for spam indicators.

| Indicator                         | Score Impact | Description                        |
| --------------------------------- | ------------ | ---------------------------------- |
| URL shortener in link             | +0.25        | Often used to hide malicious links |
| Suspicious TLD (.xyz, .top, etc.) | +0.20        | Commonly used for spam domains     |
| 5+ URLs in content                | +0.20        | Excessive link dropping            |
| 3-4 URLs in content               | +0.10        | Elevated link count                |
| URL shorteners in content         | +0.15 each   | Hidden links in text               |
| Excessive capitalization          | +0.10        | SHOUTING (spam indicator)          |
| Repetitive patterns               | +0.15        | Repeated text (bot behavior)       |

**Suspicious TLDs**: `.xyz`, `.top`, `.click`, `.loan`, `.work`, `.gq`, `.cf`, `.tk`, `.ml`, `.ga`

**URL Shorteners Detected**: bit.ly, tinyurl.com, t.co, goo.gl, ow.ly, is.gd, buff.ly, adf.ly, j.mp, rb.gy, cutt.ly, shorturl.at, tiny.cc, s.id, v.gd, clck.ru

### 5. Velocity Risk (Weight: 12% without IP, 8% with IP)

Measures how frequently an author is publishing to detect burst spam behavior. Queries the database to count actual publications by the author in the last hour and last 24 hours.

| Publications/Hour | Risk Score | Description          |
| ----------------- | ---------- | -------------------- |
| 0-2               | 0.10       | Normal posting rate  |
| 3-5               | 0.40       | Elevated rate        |
| 6-10              | 0.70       | Suspicious rate      |
| 20+               | 0.95       | Likely automated/bot |

The effective rate is calculated as the maximum of:

- Publications in the last hour
- Average publications per hour over the last 24 hours

### 6. Wallet Velocity Risk (Weight: 15% without IP, 15% with IP)

Tracks publication velocity by wallet address from `author.wallets`. Detects coordinated spam from users who share the same wallet-verified identity (e.g., mintpass NFT holders).

This factor uses publication-type-specific thresholds since different actions have different natural rates.

**Post thresholds (comments without parentCid):**

| Posts/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-2        | 0.10       | Normal posting rate  |
| 3-5        | 0.40       | Elevated rate        |
| 6-8        | 0.70       | Suspicious rate      |
| 12+        | 0.95       | Likely automated/bot |

**Reply thresholds (comments with parentCid):**

| Replies/Hour | Risk Score | Description          |
| ------------ | ---------- | -------------------- |
| 0-5          | 0.10       | Normal posting rate  |
| 6-10         | 0.40       | Elevated rate        |
| 11-15        | 0.70       | Suspicious rate      |
| 25+          | 0.95       | Likely automated/bot |

**Vote thresholds:**

| Votes/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-20       | 0.10       | Normal voting rate   |
| 21-40      | 0.40       | Elevated rate        |
| 41-60      | 0.70       | Suspicious rate      |
| 100+       | 0.95       | Likely automated/bot |

**Comment edit thresholds:**

| Edits/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-3        | 0.10       | Normal editing rate  |
| 4-5        | 0.40       | Elevated rate        |
| 6-10       | 0.70       | Suspicious rate      |
| 15+        | 0.95       | Likely automated/bot |

**Note**: If an author has multiple wallets, the factor uses the highest velocity among all wallets. If no wallets are linked to the author, this factor is skipped (weight=0).

### 7. IP Risk (Weight: 0% without IP, 25% with IP)

When available (after iframe access), evaluates the author's IP address characteristics.

| IP Type     | Risk Score | Description           |
| ----------- | ---------- | --------------------- |
| Residential | 0.20       | Normal user IP        |
| Datacenter  | 0.70       | Often used for bots   |
| VPN         | 0.75       | Anonymizing service   |
| Proxy       | 0.85       | Anonymizing service   |
| Tor         | 0.95       | Highest anonymization |

**Note**: IP intelligence is best-effort and can have false positives. Use for informational purposes and rejection decisions only, not for auto-approval.

## Weight Distribution

Weights are redistributed based on whether IP information is available:

| Factor            | Without IP | With IP  |
| ----------------- | ---------- | -------- |
| Author Reputation | 25%        | 20%      |
| Content Risk      | 18%        | 12%      |
| Velocity Risk     | 12%        | 8%       |
| Account Age       | 17%        | 12%      |
| Karma Score       | 13%        | 8%       |
| Wallet Velocity   | 15%        | 15%      |
| IP Risk           | 0%         | 25%      |
| **Total**         | **100%**   | **100%** |

## Score Calculation

The final score is computed as:

```
finalScore = Σ(factor.score × factor.weight) / Σ(factor.weight)
```

Each factor produces a score between 0.0 and 1.0, which is multiplied by its weight. The weighted scores are summed and normalized.

## Recommended Thresholds

These are suggested defaults for subplebbit configuration:

| Threshold             | Suggested Value | Action                                    |
| --------------------- | --------------- | ----------------------------------------- |
| `autoAcceptThreshold` | 0.2             | Auto-accept publications below this score |
| `autoRejectThreshold` | 0.8             | Auto-reject publications above this score |

Publications between these thresholds trigger a challenge (e.g., CAPTCHA).

## Limitations

1. **IP Intelligence Accuracy**: VPN/proxy detection is imperfect. Residential IPs can be misclassified.

2. **New Subplebbit Limitation**: For new subplebbits, `author.subplebbit` data may be empty for all users initially.

3. **Content Analysis Scope**: Currently focuses on URL patterns. Does not analyze semantic content or detect sophisticated spam.

## Future Improvements

- Cross-subplebbit reputation aggregation
- Challenge completion history tracking
- Machine learning-based content analysis
- Moderation action history integration
