# Risk Scoring System

This document explains how EasyCommunitySpamBlocker calculates risk scores for publications.

## Overview

The risk score is a value between 0.0 and 1.0 that indicates the likelihood a publication is spam or malicious:

- **0.0 - 0.3**: Low risk (likely legitimate)
- **0.3 - 0.7**: Moderate risk (may require verification)
- **0.7 - 1.0**: High risk (likely spam/malicious)

The score is calculated as a weighted combination of multiple factors, each analyzing different aspects of the publication and its author.

## Trust Model

**Important**: Not all author data can be trusted equally.

- `author.subplebbit.*` fields are **TRUSTED** - they are generated by the subplebbit and verified
- All other `author.*` fields are **UNTRUSTED** - they are provided by the user and can be faked

**Exception**: `author.wallets` and `author.avatar` contain signatures that are verified by plebbit-js, proving actual wallet ownership. While these fields are user-provided, the verified wallet addresses can be used as reliable identifiers for tracking coordinated activity.

The risk scoring system primarily relies on trusted `author.subplebbit` data for reputation signals.

## Author Identity Tracking

**Important**: `author.address` is NOT used for identity tracking.

The `author.address` field can be either:

- A b58-encoded IPNS address (cryptographically tied to the author's key)
- A domain name (not cryptographically tied to the author)

Since `author.address` can be a domain that the author controls but doesn't cryptographically prove ownership of, we use the **signature's public key** (`publication.signature.publicKey`) for all identity-related tracking:

- Velocity tracking (how fast an author is posting)
- Karma aggregation (author's reputation across subplebbits)
- Account age (first seen timestamp)
- Content similarity detection (same author vs. different authors)
- Link spam detection (same author vs. coordinated campaigns)

The Ed25519 public key in the signature is the cryptographic identifier that truly identifies the author across all their publications.

## Risk Factors

### 1. Account Age (Weight: 15% without IP, 10% with IP)

Evaluates how long the author has been active, using the **older** of:

1. `author.subplebbit.firstCommentTimestamp` (TRUSTED - from subplebbit)
2. First seen timestamp from the spam detection database

This dual-source approach ensures we capture the earliest known activity even when the subplebbit data is incomplete or when the spam detection system has older records.

| Account Age | Risk Score | Description                            |
| ----------- | ---------- | -------------------------------------- |
| > 365 days  | 0.10       | Very established, highly trusted       |
| > 90 days   | 0.20       | Established account                    |
| > 30 days   | 0.35       | Moderately established                 |
| > 7 days    | 0.50       | Some history                           |
| > 1 day     | 0.70       | New account                            |
| < 1 day     | 0.85       | Very new account                       |
| No history  | 0.90       | First interaction with this subplebbit |

**Rationale**: Older accounts have demonstrated sustained, non-malicious behavior over time.

### 2. Karma Score (Weight: 11% without IP, 7% with IP)

Evaluates the author's accumulated karma (`postScore + replyScore`) using a weighted combination of:

1. **Current subplebbit karma** (70% weight): From `author.subplebbit` (TRUSTED)
2. **Other subplebbits karma** (30% weight): Aggregated from the spam detection database

This dual-source approach gives priority to the author's reputation in the current subplebbit while still considering their cross-community reputation. A user who is problematic in one subplebbit won't automatically get a pass just because they have good karma elsewhere.

**Karma aggregation from database:**

- Only the **latest** karma per subplebbit is counted (avoids summing duplicates)
- Karma is extracted from stored publications (comments, votes, edits, moderations)
- The current subplebbit's karma from the challenge request is always used (most recent and direct from subplebbit)

**Weighted calculation:**

- If no other subs in DB: `totalKarma = currentSubKarma`
- If other subs exist: `totalKarma = (currentSubKarma × 0.7) + (otherSubsKarma × 0.3)`

| Total Karma | Risk Score | Description                       |
| ----------- | ---------- | --------------------------------- |
| >= 100      | 0.10       | Highly trusted contributor        |
| >= 50       | 0.20       | Established contributor           |
| >= 10       | 0.35       | Positive contributor              |
| >= 0        | 0.50       | Neutral                           |
| >= -10      | 0.70       | Negative karma                    |
| < -10       | 0.90       | Very negative karma (problematic) |

**Rationale**: Karma reflects community trust. High karma indicates valued contributions; negative karma indicates problematic behavior. Weighting current sub karma higher ensures that an author's local reputation takes precedence over their global reputation.

### 3. Author Reputation (Weight: 22% without IP, 18% with IP)

Evaluates whether the author has verified publication history in this subplebbit.

| Signal               | Score Impact | Description                                |
| -------------------- | ------------ | ------------------------------------------ |
| Has `lastCommentCid` | -0.20        | Verified history exists in this subplebbit |
| No verified history  | +0.10        | No record of previous activity             |

**Note**: We intentionally do NOT use `author.previousCommentCid` as a trust signal because it's user-provided and can be faked.

**Rationale**: Authors with verified publication history have demonstrated willingness to participate legitimately.

### 4. Comment Content/Title Risk (Weight: 15% without IP, 10% with IP)

Analyzes comment content and title for spam indicators by querying the database for similar past publications. **Only applies to comments (posts and replies)** - returns neutral score (0.5) for other publication types.

**Similarity detection uses:**

1. SQL substring matching (LIKE) to find candidate matches
2. Jaccard similarity on word sets to calculate actual similarity (threshold: 60%)

| Indicator                                      | Score Impact | Description                            |
| ---------------------------------------------- | ------------ | -------------------------------------- |
| **Same Author - Content Duplicates**           |              |                                        |
| 5+ duplicate comments from same author in 24h  | +0.35        | Heavy self-spamming                    |
| 3-4 duplicate comments from same author in 24h | +0.25        | Moderate self-spamming                 |
| 1-2 duplicate comments from same author in 24h | +0.15        | Possible duplicate posting             |
| **Same Author - Similar Content**              |              |                                        |
| 3+ similar comments from same author in 24h    | +0.20        | Similar content spamming               |
| 1-2 similar comments from same author in 24h   | +0.10        | Possible template spam                 |
| **Other Authors - Content Duplicates**         |              |                                        |
| 5+ identical comments from other authors       | +0.40        | Coordinated spam campaign              |
| 2-4 identical comments from other authors      | +0.25        | Possible coordinated activity          |
| 1 identical comment from another author        | +0.10        | Content seen from another author       |
| **Other Authors - Similar Content**            |              |                                        |
| 3+ similar comments from other authors         | +0.20        | Similar content from multiple accounts |
| 1-2 similar comments from other authors        | +0.08        | Similar content seen elsewhere         |
| **Same Author - Title Duplicates**             |              |                                        |
| 3+ posts with same title from author in 24h    | +0.30        | Title spam                             |
| 1-2 posts with same title from author in 24h   | +0.15        | Possible duplicate posting             |
| **Same Author - Similar Titles**               |              |                                        |
| 2+ posts with similar title from author in 24h | +0.15        | Similar title spamming                 |
| **Other Authors - Title Duplicates**           |              |                                        |
| 3+ posts with same title from other authors    | +0.25        | Coordinated title spam                 |
| 1-2 posts with same title from another author  | +0.10        | Title seen from another author         |
| **Other Authors - Similar Titles**             |              |                                        |
| 2+ posts with similar title from other authors | +0.10        | Similar titles from multiple accounts  |
| **Static Content Analysis**                    |              |                                        |
| 5+ URLs in content                             | +0.15        | Excessive link dropping                |
| 3-4 URLs in content                            | +0.08        | Elevated link count                    |
| Excessive capitalization (>50% caps)           | +0.08        | SHOUTING (spam indicator)              |
| Repetitive patterns (repeated chars/words)     | +0.10        | Bot-like behavior                      |

**Note**: The base score for comments starts at 0.2 (low risk). Non-comment publications receive a neutral score of 0.5.

### 5. Comment URL/Link Risk (Weight: 12% without IP, 10% with IP)

Analyzes `comment.link` (the dedicated link field for link posts) for spam indicators. This is separate from URLs found in `comment.content`. **Only applies to comments (posts and replies) that have a link** - returns neutral score (0.5) for other publications or comments without links.

| Indicator                                         | Score Impact | Description                      |
| ------------------------------------------------- | ------------ | -------------------------------- |
| **Same Author - Duplicate Links**                 |              |                                  |
| 5+ posts with same link from author in 24h        | +0.40        | Heavy link spam                  |
| 3-4 posts with same link from author in 24h       | +0.25        | Moderate link spam               |
| 1-2 posts with same link from author in 24h       | +0.15        | Possible duplicate posting       |
| **Other Authors - Duplicate Links (Coordinated)** |              |                                  |
| 10+ posts with same link from other authors       | +0.50        | Likely coordinated spam campaign |
| 5-9 posts with same link from other authors       | +0.35        | Possible coordinated spam        |
| 2-4 posts with same link from other authors       | +0.20        | Link seen from multiple authors  |
| 1 post with same link from another author         | +0.10        | Link seen from another author    |
| **Domain Spam (Same Author)**                     |              |                                  |
| 10+ links to same domain from author in 24h       | +0.25        | Domain-focused spam              |
| 5-9 links to same domain from author in 24h       | +0.15        | Elevated domain promotion        |
| **Suspicious URL Patterns**                       |              |                                  |
| Uses URL shortener (bit.ly, tinyurl, etc.)        | +0.15        | Link obfuscation                 |
| Uses IP address instead of domain                 | +0.20        | Suspicious direct IP link        |
| Unusually long URL (>500 chars)                   | +0.10        | Possible obfuscation             |
| Excessive query parameters (>5)                   | +0.05        | Possible tracking/affiliate link |
| Invalid URL format                                | +0.10        | Malformed link                   |

**Note**: The base score for comments with links starts at 0.2 (low risk). Non-comment publications or comments without links receive a neutral score of 0.5. URL normalization removes tracking parameters (utm\_\*, fbclid, etc.) before comparison.

### 6. Velocity Risk (Weight: 10% without IP, 7% with IP)

Measures how frequently an author is publishing to detect burst spam behavior. Queries the database to count actual publications by the author's **signature public key** in the last hour and last 24 hours.

This factor uses publication-type-specific thresholds since different actions have different natural rates:

**Post thresholds (comments without parentCid):**

| Posts/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-2        | 0.10       | Normal posting rate  |
| 3-5        | 0.40       | Elevated rate        |
| 6-8        | 0.70       | Suspicious rate      |
| 12+        | 0.95       | Likely automated/bot |

**Reply thresholds (comments with parentCid):**

| Replies/Hour | Risk Score | Description          |
| ------------ | ---------- | -------------------- |
| 0-5          | 0.10       | Normal posting rate  |
| 6-10         | 0.40       | Elevated rate        |
| 11-15        | 0.70       | Suspicious rate      |
| 25+          | 0.95       | Likely automated/bot |

**Vote thresholds:**

| Votes/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-20       | 0.10       | Normal voting rate   |
| 21-40      | 0.40       | Elevated rate        |
| 41-60      | 0.70       | Suspicious rate      |
| 100+       | 0.95       | Likely automated/bot |

**Comment edit thresholds:**

| Edits/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-3        | 0.10       | Normal editing rate  |
| 4-5        | 0.40       | Elevated rate        |
| 6-10       | 0.70       | Suspicious rate      |
| 15+        | 0.95       | Likely automated/bot |

**Comment moderation thresholds:**

| Moderations/Hour | Risk Score | Description            |
| ---------------- | ---------- | ---------------------- |
| 0-5              | 0.10       | Normal moderation rate |
| 6-10             | 0.40       | Elevated rate          |
| 11-15            | 0.70       | Suspicious rate        |
| 25+              | 0.95       | Likely automated/bot   |

The effective rate is calculated as the maximum of:

- Publications of that type in the last hour
- Average publications per hour over the last 24 hours

**Note**: Subplebbit edits are not tracked for velocity as they are administrative actions.

### 7. Wallet Velocity Risk (Weight: 15% without IP, 15% with IP)

Tracks publication velocity by wallet address from `author.wallets`. Detects coordinated spam from users who share the same wallet-verified identity (e.g., mintpass NFT holders).

This factor uses publication-type-specific thresholds since different actions have different natural rates.

**Post thresholds (comments without parentCid):**

| Posts/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-2        | 0.10       | Normal posting rate  |
| 3-5        | 0.40       | Elevated rate        |
| 6-8        | 0.70       | Suspicious rate      |
| 12+        | 0.95       | Likely automated/bot |

**Reply thresholds (comments with parentCid):**

| Replies/Hour | Risk Score | Description          |
| ------------ | ---------- | -------------------- |
| 0-5          | 0.10       | Normal posting rate  |
| 6-10         | 0.40       | Elevated rate        |
| 11-15        | 0.70       | Suspicious rate      |
| 25+          | 0.95       | Likely automated/bot |

**Vote thresholds:**

| Votes/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-20       | 0.10       | Normal voting rate   |
| 21-40      | 0.40       | Elevated rate        |
| 41-60      | 0.70       | Suspicious rate      |
| 100+       | 0.95       | Likely automated/bot |

**Comment edit thresholds:**

| Edits/Hour | Risk Score | Description          |
| ---------- | ---------- | -------------------- |
| 0-3        | 0.10       | Normal editing rate  |
| 4-5        | 0.40       | Elevated rate        |
| 6-10       | 0.70       | Suspicious rate      |
| 15+        | 0.95       | Likely automated/bot |

**Note**: If an author has multiple wallets, the factor uses the highest velocity among all wallets. If no wallets are linked to the author, this factor is skipped (weight=0).

### 8. IP Risk (Weight: 0% without IP, 23% with IP)

When available (after iframe access), evaluates the author's IP address characteristics.

| IP Type     | Risk Score | Description           |
| ----------- | ---------- | --------------------- |
| Residential | 0.20       | Normal user IP        |
| Datacenter  | 0.70       | Often used for bots   |
| VPN         | 0.75       | Anonymizing service   |
| Proxy       | 0.85       | Anonymizing service   |
| Tor         | 0.95       | Highest anonymization |

**Note**: IP intelligence is best-effort and can have false positives. Use for informational purposes and rejection decisions only, not for auto-approval.

## Weight Distribution

Weights are redistributed based on whether IP information is available:

| Factor                     | Without IP | With IP  |
| -------------------------- | ---------- | -------- |
| Author Reputation          | 22%        | 18%      |
| Comment Content/Title Risk | 15%        | 10%      |
| Comment URL/Link Risk      | 12%        | 10%      |
| Velocity Risk              | 10%        | 7%       |
| Account Age                | 15%        | 10%      |
| Karma Score                | 11%        | 7%       |
| Wallet Velocity            | 15%        | 15%      |
| IP Risk                    | 0%         | 23%      |
| **Total**                  | **100%**   | **100%** |

## Score Calculation

The final score is computed as:

```
finalScore = Σ(factor.score × factor.weight) / Σ(factor.weight)
```

Each factor produces a score between 0.0 and 1.0, which is multiplied by its weight. The weighted scores are summed and normalized.

## Recommended Thresholds

These are suggested defaults for subplebbit configuration:

| Threshold             | Suggested Value | Action                                    |
| --------------------- | --------------- | ----------------------------------------- |
| `autoAcceptThreshold` | 0.2             | Auto-accept publications below this score |
| `autoRejectThreshold` | 0.8             | Auto-reject publications above this score |

Publications between these thresholds trigger a challenge (e.g., CAPTCHA).

## Limitations

1. **IP Intelligence Accuracy**: VPN/proxy detection is imperfect. Residential IPs can be misclassified.

2. **New Subplebbit Limitation**: For new subplebbits, `author.subplebbit` data may be empty for all users initially.

3. **Content Similarity Scope**: Uses word-level Jaccard similarity (60% threshold). May miss semantically similar content that uses different words. Substring matching helps catch some variations but sophisticated paraphrasing may evade detection.

4. **Comment-Only Content Analysis**: Content/title similarity analysis only applies to comments (posts and replies). Other publication types (votes, edits, moderations) receive a neutral score for this factor.

## Future Improvements

- Challenge completion history tracking
- Machine learning-based content analysis
- Moderation action history integration
